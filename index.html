<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Tracker - NYT Top 100</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: #ffffff !important;
            background-color: #ffffff !important;
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            background: #ffffff !important;
            background-color: #ffffff !important;
            color: #000000 !important;
            line-height: 1.6;
            font-size: 16px;
            color-scheme: light !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            background: #ffffff !important;
        }

        /* Header simple */
        header {
            border-bottom: 1px solid #ddd;
            padding: 20px 0;
            margin-bottom: 30px;
            background: #ffffff !important;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            color: #000000 !important;
        }

        .subtitle {
            text-align: center;
            color: #666666 !important;
            font-size: 1rem;
            font-style: italic;
        }

        /* Navigation simple */
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
            background: #ffffff !important;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            font-size: 16px;
            width: 300px;
            max-width: 100%;
            background: #ffffff !important;
            color: #000000 !important;
        }

        .search-input:focus {
            outline: none;
            border-color: #000000 !important;
            background: #ffffff !important;
        }

        .filters {
            display: flex;
            gap: 0;
            border: 1px solid #ccc;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #ffffff !important;
            border: none;
            border-right: 1px solid #ccc;
            cursor: pointer;
            font-size: 14px;
            color: #000000 !important;
        }

        .filter-btn:last-child {
            border-right: none;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: #000000 !important;
            color: #ffffff !important;
        }

        .ai-button {
            background: #000000 !important;
            color: #ffffff !important;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
        }

        .ai-button:hover {
            background: #333333 !important;
        }

        /* Stats simples */
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            background: #ffffff !important;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            display: block;
            color: #000000 !important;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666666 !important;
        }

        /* Grid de films */
        .movies-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .movie-item {
            border: 1px solid #ddd;
            background: #ffffff !important;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .movie-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .movie-item.watched {
            border-color: #000000 !important;
            border-width: 2px;
        }

        .movie-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            background: #f0f0f0;
            display: block;
        }

        .movie-poster.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
            text-align: center;
            padding: 20px;
            aspect-ratio: 2/3;
            background: #f5f5f5;
        }

        .movie-details {
            padding: 12px;
        }

        .movie-title {
            font-size: 0.95rem;
            font-weight: bold;
            margin-bottom: 4px;
            line-height: 1.2;
            color: #000000 !important;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .movie-title-fr {
            font-size: 0.85rem;
            color: #666666 !important;
            font-style: italic;
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .movie-year {
            font-size: 0.85rem;
            color: #666666 !important;
            margin-bottom: 10px;
        }

        .watch-status {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            background: #ffffff !important;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            color: #000000 !important;
            transition: all 0.2s ease;
        }

        .watch-status:hover {
            background: #f0f0f0 !important;
        }

        .watch-status.watched {
            background: #000000 !important;
            color: #ffffff !important;
            border-color: #000000 !important;
        }

        /* Modal simple */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff !important;
            border: 1px solid #ccc;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #000000 !important;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            color: #000000 !important;
        }

        .chat-area {
            border: 1px solid #ddd;
            height: 300px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            background: #ffffff !important;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            max-width: 80%;
        }

        .message.user {
            background: #000;
            color: #fff;
            margin-left: auto;
        }

        .message.ai {
            background: #fff;
            border: 1px solid #ddd;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .chat-input input:focus {
            outline: none;
            border-color: #000;
        }

        .send-btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
        }

        .send-btn:hover {
            background: #333;
        }

        /* Notification simple */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #000000 !important;
            color: #ffffff !important;
            padding: 12px 20px;
            border: 1px solid #000000 !important;
            z-index: 10000;
            font-size: 14px;
        }

        .notification.error {
            background: #d00000 !important;
            border-color: #d00000 !important;
            color: #ffffff !important;
        }

        .notification.warning {
            background: #ff9800 !important;
            border-color: #ff9800 !important;
            color: #ffffff !important;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1rem;
            color: #666666 !important;
            background: #ffffff !important;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .movies-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .movies-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 992px) {
            .movies-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .nav {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                width: 100%;
                margin-bottom: 15px;
            }

            .stats {
                gap: 20px;
                flex-direction: column;
            }

            .stat {
                border-bottom: 1px solid #ddd;
                padding-bottom: 10px;
            }

            .stat:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .movies-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .movie-title {
                font-size: 0.9rem;
            }

            .movie-title-fr {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .movies-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .filters {
                width: 100%;
            }

            .filter-btn {
                flex: 1;
                font-size: 12px;
                padding: 6px 8px;
            }

            .movie-details {
                padding: 8px;
            }

            .movie-title {
                font-size: 0.85rem;
            }

            .watch-status {
                font-size: 11px;
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Movie Tracker</h1>
            <div class="subtitle">Les 100 meilleurs films du 21ème siècle selon le New York Times</div>
        </header>

        <nav class="nav">
            <input type="text" class="search-input" placeholder="Rechercher un film..." id="searchInput">
            
            <div class="filters">
                <button class="filter-btn active" data-filter="all">Tous</button>
                <button class="filter-btn" data-filter="unwatched">À voir</button>
                <button class="filter-btn" data-filter="watched">Vus</button>
            </div>

            <button class="ai-button" id="openAI">
                <i class="fas fa-robot"></i> Assistant IA
            </button>
        </nav>

        <div class="stats">
            <div class="stat">
                <span class="stat-number" id="totalCount">100</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat">
                <span class="stat-number" id="watchedCount">0</span>
                <span class="stat-label">Vus</span>
            </div>
            <div class="stat">
                <span class="stat-number" id="unwatchedCount">100</span>
                <span class="stat-label">À voir</span>
            </div>
            <div class="stat">
                <span class="stat-number" id="progressPercent">0%</span>
                <span class="stat-label">Progression</span>
            </div>
        </div>

        <div class="movies-grid" id="moviesContainer">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i><br>
                Chargement des films...
            </div>
        </div>
    </div>

    <!-- Modal Assistant IA -->
    <div class="modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Assistant Cinéma</h3>
                <button class="close-btn" id="closeAI">×</button>
            </div>
            <div class="chat-area" id="chatArea">
                <div class="message ai">
                    Bonjour ! Je suis votre assistant cinéma. Je peux vous aider à choisir votre prochain film à regarder. Que recherchez-vous aujourd'hui ?
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Tapez votre message...">
                <button class="send-btn" id="sendMessage">Envoyer</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_SHEETS_API_KEY: 'AIzaSyD8uw55tuJcdtqUanZ7J3DbsZeHCn-eSrM',
            GOOGLE_SHEET_ID: '1Uwa978kVrXQX6knh3w832T18mhsP3PZhV7v95Yi0eS8',
            SHEET_NAME: 'list',
            OPENAI_API_KEY: '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',
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwFeoGtRYruRXDOnzqbwVo-HpiRWZ8sq6G2TA1u4KfsDO7ffCW1-FSvqGLKaEDTQXe4/exec'
        };

        // État de l'application
        let movies = [];
        let currentFilter = 'all';
        let searchTerm = '';

        // Données de démonstration étendues
        const DEMO_MOVIES = [
            {
                titreOriginal: "Parasite",
                titreFrancais: "Parasite",
                annee: "2019",
                affiche: "https://image.tmdb.org/t/p/w500/7IiTTgloJzvGI1TAYymCfbfl3vT.jpg",
                vu: false
            },
            {
                titreOriginal: "Mulholland Drive",
                titreFrancais: "Mulholland Drive",
                annee: "2001",
                affiche: "https://image.tmdb.org/t/p/w500/tVxGt7uffLVhIIcwuldXOMpFBPX.jpg",
                vu: false
            },
            {
                titreOriginal: "There Will Be Blood",
                titreFrancais: "There Will Be Blood",
                annee: "2007",
                affiche: "https://image.tmdb.org/t/p/w500/fa0RDkAlCec0STeMNAhPaF89q6U.jpg",
                vu: false
            },
            {
                titreOriginal: "In the Mood for Love",
                titreFrancais: "In the Mood for Love",
                annee: "2000",
                affiche: "https://image.tmdb.org/t/p/w500/iYypPT4bhqXTBVzjjw0Odu6snRD.jpg",
                vu: false
            },
            {
                titreOriginal: "Moonlight",
                titreFrancais: "Moonlight",
                annee: "2016",
                affiche: "https://image.tmdb.org/t/p/w500/4911T5FbJ9eD2fAZEDiKJTPh8AV.jpg",
                vu: false
            },
            {
                titreOriginal: "No Country for Old Men",
                titreFrancais: "No Country for Old Men",
                annee: "2007",
                affiche: "https://image.tmdb.org/t/p/w500/bR6vjGue1Hue3m8oovEUGpmHLqf.jpg",
                vu: false
            },
            {
                titreOriginal: "Get Out",
                titreFrancais: "Get Out",
                annee: "2017",
                affiche: "https://image.tmdb.org/t/p/w500/tFXcEccSQMf3lfhfXKSU9iRBpa3.jpg",
                vu: false
            },
            {
                titreOriginal: "Spirited Away",
                titreFrancais: "Le Voyage de Chihiro",
                annee: "2001",
                affiche: "https://image.tmdb.org/t/p/w500/39wmItIWsg5sZMyRUHLkWBcuVCM.jpg",
                vu: false
            },
            {
                titreOriginal: "The Social Network",
                titreFrancais: "The Social Network",
                annee: "2010",
                affiche: "https://image.tmdb.org/t/p/w500/n0ybibhJtQ5icDqTp8eRytcIHJx.jpg",
                vu: false
            },
            {
                titreOriginal: "Mad Max: Fury Road",
                titreFrancais: "Mad Max: Fury Road",
                annee: "2015",
                affiche: "https://image.tmdb.org/t/p/w500/hA2ple9q4qnwxp3hKVNhroipsir.jpg",
                vu: false
            }
        ];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            loadMovies();
            setupEventListeners();
        }

        function setupEventListeners() {
            // Recherche
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchTerm = e.target.value.toLowerCase();
                displayMovies();
            });

            // Filtres
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    displayMovies();
                });
            });

            // Assistant IA
            document.getElementById('openAI').addEventListener('click', () => {
                document.getElementById('aiModal').style.display = 'block';
            });

            document.getElementById('closeAI').addEventListener('click', () => {
                document.getElementById('aiModal').style.display = 'none';
            });

            document.getElementById('sendMessage').addEventListener('click', sendAIMessage);
            
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });

            // Fermer modal en cliquant à l'extérieur
            document.getElementById('aiModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        }

        function loadMovies() {
            // Charger depuis Google Sheets via Apps Script
            loadFromGoogleSheets()
                .then(() => {
                    displayMovies();
                    updateStats();
                    console.log('Films chargés avec succès');
                })
                .catch(error => {
                    console.error('Erreur lors du chargement:', error);
                    // Ne pas afficher de notification d'erreur si on a quand même des films
                    if (movies.length === 0) {
                        showNotification('Chargement en mode démo', 'warning');
                        loadDemoData();
                    }
                    displayMovies();
                    updateStats();
                });
        }

        async function loadFromGoogleSheets() {
            // Utiliser Apps Script en priorité (fonctionne mieux)
            if (CONFIG.APPS_SCRIPT_URL) {
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'getAllMovies');
                    
                    const url = `${CONFIG.APPS_SCRIPT_URL}?${params.toString()}`;
                    console.log('Chargement des films:', url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.success && data.movies) {
                        movies = data.movies;
                        
                        // Charger l'état sauvegardé localement pour synchroniser
                        const saved = localStorage.getItem('movieWatchedStatus');
                        if (saved) {
                            const watchedStatus = JSON.parse(saved);
                            movies.forEach(movie => {
                                if (watchedStatus[movie.titreOriginal] !== undefined) {
                                    movie.vu = watchedStatus[movie.titreOriginal];
                                }
                            });
                        }
                        
                        console.log(`${movies.length} films chargés via Apps Script`);
                        return;
                    }
                } catch (error) {
                    console.warn('Erreur Apps Script, essai avec l\'API directe:', error);
                }
            }
            
            // Fallback : utiliser l'API Google Sheets directe
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.GOOGLE_SHEET_ID}/values/${CONFIG.SHEET_NAME}!A:E?key=${CONFIG.GOOGLE_SHEETS_API_KEY}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Erreur 403: Le Google Sheet doit être partagé publiquement (Partager > Toute personne disposant du lien > Lecteur)');
                }
                throw new Error(`Erreur Google Sheets: ${response.status}`);
            }
            
            const data = await response.json();
            const rows = data.values;
            
            if (!rows || rows.length < 2) {
                throw new Error('Aucune donnée trouvée dans Google Sheets');
            }
            
            // Parse les données (ignore la première ligne d'en-têtes)
            movies = rows.slice(1).map((row, index) => ({
                titreOriginal: row[1] || row[0] || '', // Colonne B en priorité, sinon A
                titreFrancais: row[1] || '',
                annee: row[2] || '',
                affiche: row[3] || '',
                vu: row[4] === 'true' || row[4] === 'TRUE',
                rowIndex: index + 2 // +1 pour l'en-tête, +1 pour l'index Google Sheets
            }));
            
            // Charger l'état sauvegardé localement
            const saved = localStorage.getItem('movieWatchedStatus');
            if (saved) {
                const watchedStatus = JSON.parse(saved);
                movies.forEach(movie => {
                    if (watchedStatus[movie.titreOriginal] !== undefined) {
                        movie.vu = watchedStatus[movie.titreOriginal];
                    }
                });
            }
            
            console.log(`${movies.length} films chargés depuis Google Sheets`);
        }

        function loadDemoData() {
            // Charger les données sauvegardées localement
            const saved = localStorage.getItem('movieWatchedStatus');
            if (saved) {
                const watchedStatus = JSON.parse(saved);
                DEMO_MOVIES.forEach(movie => {
                    if (watchedStatus[movie.titreOriginal] !== undefined) {
                        movie.vu = watchedStatus[movie.titreOriginal];
                    }
                });
            }
            
            movies = DEMO_MOVIES;
            console.log(`${movies.length} films chargés en mode démo`);
        }

        function displayMovies() {
            let filteredMovies = movies.filter(movie => {
                // Filtre par statut
                if (currentFilter === 'watched' && !movie.vu) return false;
                if (currentFilter === 'unwatched' && movie.vu) return false;
                
                // Filtre par recherche
                if (searchTerm && 
                    !movie.titreOriginal.toLowerCase().includes(searchTerm) &&
                    !movie.titreFrancais.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                return true;
            });

            const container = document.getElementById('moviesContainer');
            
            if (filteredMovies.length === 0) {
                container.innerHTML = '<div class="loading">Aucun film trouvé</div>';
                return;
            }

            container.innerHTML = filteredMovies.map(movie => {
                const hasImage = movie.affiche && typeof movie.affiche === 'string' && movie.affiche.startsWith('http');
                
                return `
                    <article class="movie-item ${movie.vu ? 'watched' : ''}" data-title="${movie.titreOriginal}">
                        ${hasImage ? 
                            `<img src="${movie.affiche}" 
                                 alt="${movie.titreOriginal}" 
                                 class="movie-poster"
                                 onerror="this.outerHTML='<div class=\\'movie-poster placeholder\\'>Affiche non disponible</div>'">` :
                            `<div class="movie-poster placeholder">Affiche non disponible</div>`
                        }
                        <div class="movie-details">
                            <h3 class="movie-title">${movie.titreOriginal}</h3>
                            ${movie.titreFrancais && movie.titreFrancais !== movie.titreOriginal ? 
                                `<div class="movie-title-fr">${movie.titreFrancais}</div>` : ''}
                            <div class="movie-year">${movie.annee}</div>
                            <button class="watch-status ${movie.vu ? 'watched' : ''}" 
                                    data-title="${movie.titreOriginal}">
                                ${movie.vu ? '✓ Film vu' : 'Marquer comme vu'}
                            </button>
                        </div>
                    </article>
                `;
            }).join('');

            // Ajouter les événements
            document.querySelectorAll('.watch-status').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleWatched(this.dataset.title);
                });
            });

            document.querySelectorAll('.movie-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Ne pas déclencher si on clique sur le bouton
                    if (!e.target.classList.contains('watch-status')) {
                        toggleWatched(this.dataset.title);
                    }
                });
            });
        }

        function toggleWatched(movieTitle) {
            const movie = movies.find(m => m.titreOriginal === movieTitle);
            if (!movie) return;

            movie.vu = !movie.vu;
            
            // Sauvegarder localement
            const watchedStatus = {};
            movies.forEach(m => {
                watchedStatus[m.titreOriginal] = m.vu;
            });
            localStorage.setItem('movieWatchedStatus', JSON.stringify(watchedStatus));
            
            // Essayer de sauvegarder sur Google Sheets via Apps Script
            if (CONFIG.APPS_SCRIPT_URL) {
                updateGoogleSheets(movie)
                    .then(() => {
                        console.log(`Film "${movieTitle}" mis à jour dans Google Sheets`);
                        showNotification(`${movieTitle} marqué comme ${movie.vu ? 'vu' : 'non vu'} ✓`);
                    })
                    .catch(error => {
                        console.warn('Sauvegarde Google Sheets:', error);
                        showNotification(`${movieTitle} sauvegardé localement (Google Sheets inaccessible)`, 'warning');
                    });
            } else {
                showNotification(`${movieTitle} marqué comme ${movie.vu ? 'vu' : 'non vu'}`);
            }
            
            // Mettre à jour l'affichage
            displayMovies();
            updateStats();
        }

        async function updateGoogleSheets(movie) {
            if (!CONFIG.APPS_SCRIPT_URL || CONFIG.APPS_SCRIPT_URL === '' || !movie.rowIndex) {
                throw new Error('Configuration Apps Script manquante');
            }

            try {
                // Utiliser URLSearchParams comme dans l'exemple qui fonctionne
                const params = new URLSearchParams();
                params.append('action', 'updateStatus');
                params.append('rowIndex', movie.rowIndex.toString());
                params.append('status', movie.vu.toString());
                
                const url = `${CONFIG.APPS_SCRIPT_URL}?${params.toString()}`;
                
                console.log('Envoi de la requête:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Erreur lors de la mise à jour');
                }
                
                console.log('✅ Mise à jour Google Sheets réussie:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Erreur lors de la mise à jour:', error);
                throw error;
            }
        }

        function updateStats() {
            const total = movies.length;
            const watched = movies.filter(m => m.vu).length;
            const unwatched = total - watched;
            const progress = total > 0 ? Math.round((watched / total) * 100) : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('watchedCount').textContent = watched;
            document.getElementById('unwatchedCount').textContent = unwatched;
            document.getElementById('progressPercent').textContent = progress + '%';
        }

        function sendAIMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            addMessageToChat(message, 'user');
            input.value = '';

            // Appel à OpenAI API
            callOpenAI(message)
                .then(response => {
                    addMessageToChat(response, 'ai');
                })
                .catch(error => {
                    console.error('Erreur OpenAI:', error);
                    // Fallback vers réponse simulée en cas d'erreur
                    const responses = [
                        "Basé sur vos goûts, je recommande Parasite pour son mélange unique de thriller et de critique sociale.",
                        "Pour une expérience cinématographique unique, essayez Mulholland Drive de David Lynch.",
                        "Si vous aimez les drames émouvants, Moonlight est un excellent choix.",
                        "Pour du suspense moderne, Get Out de Jordan Peele est parfait.",
                        "The Social Network offre un regard fascinant sur l'ère numérique."
                    ];
                    
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    setTimeout(() => addMessageToChat(response, 'ai'), 1000);
                });
        }

        async function callOpenAI(userMessage) {
            // Construire le contexte avec les films vus/non vus
            const watchedMovies = movies.filter(m => m.vu).map(m => m.titreOriginal);
            const unwatchedMovies = movies.filter(m => !m.vu).map(m => m.titreOriginal);
            
            const systemPrompt = `Tu es un assistant cinéma expert. Tu aides à choisir des films parmi le top 100 du New York Times du 21ème siècle. 

Films déjà vus par l'utilisateur: ${watchedMovies.join(', ') || 'Aucun'}
Films non vus: ${unwatchedMovies.slice(0, 20).join(', ')}...

Donne des recommandations personnalisées, courtes et engageantes. Pose des questions pour mieux comprendre les goûts.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userMessage }
                    ],
                    max_tokens: 200,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`Erreur OpenAI: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function addMessageToChat(message, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = message;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showNotification(message, type = 'success') {
            // Supprimer les notifications existantes
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
    </script>
</body>
</html>
